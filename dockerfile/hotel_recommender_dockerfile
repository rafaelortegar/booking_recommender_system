# Use Jupyter PySpark Notebook as the base image
FROM jupyter/pyspark-notebook:latest

# Switch to root user for installations
USER root

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    libssl-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    wget \
    llvm \
    libncurses5-dev \
    libncursesw5-dev \
    xz-utils \
    tk-dev \
    libffi-dev \
    liblzma-dev \
    && rm -rf /var/lib/apt/lists/*

# Install PyEnv in a shared location (/opt/pyenv) for all users
RUN git clone https://github.com/pyenv/pyenv.git /opt/pyenv && \
    echo 'export PYENV_ROOT="/opt/pyenv"' >> /etc/profile && \
    echo 'export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"' >> /etc/profile && \
    echo 'eval "$(pyenv init --path)"' >> /etc/profile

# **Fix: Ensure PyEnv is available to all users**
ENV PYENV_ROOT="/opt/pyenv"
ENV PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

# Install Python 3.11.6 using PyEnv
RUN pyenv install 3.11.6 && \
    pyenv global 3.11.6

# Install Poetry
RUN curl -sSL https://install.python-poetry.org | python3 -

# **Ensure Poetry is in the PATH**
ENV PATH="/home/jovyan/.local/bin:$PATH"

# Set up Poetry for virtual environments inside the project directory
RUN poetry config virtualenvs.in-project true

# Set Jupyter to detect multiple environments
RUN echo "c.NotebookApp.kernel_spec_manager_class = 'nb_conda_kernels.KernelSpecManager'" >> /home/jovyan/.jupyter/jupyter_notebook_config.py

# Switch back to jovyan user
USER jovyan

# Create a working directory
WORKDIR /home/jovyan/work

# Set up a default command
CMD ["start-notebook.sh", "--NotebookApp.token=''"]
